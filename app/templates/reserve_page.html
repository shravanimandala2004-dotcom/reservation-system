<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='reserve_page.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='sidebar.css') }}">
    <title>Document</title>
</head>

<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <img src="{{ url_for('static', filename='RUCKUS-Networks-Logos-artwork_white-orange.png') }}" alt="Logo"
            class="logo">
        <nav>
            <a href="{{ url_for('inventory.inventory') }}" {% if request.path.startswith('/inventory') %}class="active"
                {% endif %}>Inventory</a>
            <a href="{{url_for('reservation.reserve')}}" {% if request.path.startswith('/reserve') %}class="active" {%
                endif %}>Reserve</a>
            {% if role == 'admin' %}
            <a href="{{ url_for('inventory.admin_page') }}" {% if request.path.startswith('/admin') %}class="active" {%
                endif %}>Admin Page</a>
            <a href="{{ url_for('details.details') }}" {% if request.path.startswith('/details') %}class="active" {%
                endif %}>Details</a>
            {% endif %}
        </nav>
        <div class="sidebar-logout-separator"></div>
        <a href="{{ url_for('auth.login') }}" class="logout-btn">Logout</a>
    </div>

    <div class="container">

        <h1>Reservation Details</h1>

        {% if active_count >= max_reservations %}
        <p style="color: rgb(56, 170, 215);">‚ö†Ô∏è You have already reserved {{max_reservations}} active resources. Please
            wait until one
            ends.</p>
        {% else %}
        <table id="inventoryTable">

        </table>
        {% endif %}

        {% if active_count < max_reservations %} <div class="details">
            <div class="section" style="width: 90%;">
                <form method="POST">
                    <input type="hidden" name="resource_id" value="{{ resource.id }}">
                    <input type="hidden" name="controller_id" value="{{ controller.controller_id }}">
                    <div>
                        <label for="start_datetime">Start Date & Time:</label>
                        <input type="datetime-local" id="start_datetime" name="start_datetime" required>
                    </div>

                    <div>
                        <label for="end_datetime">End Date & Time:</label>
                        <input type="datetime-local" id="end_datetime" name="end_datetime" required>
                    </div>


                    <button type="submit" class="reserve-btn" id="reserveBtn" disabled>Confirm Reservation</button>
                </form>
            </div>
    </div>
    {% endif %}
    </div>

    <div class="container">
        {% if active_reservations %}
        <h3>Your Active Reservations</h3>
        <ul class="reservation-list">
            {% for r in active_reservations %}
            <li>
                {% if r.resource_name != None %}
                <strong>{{ r.resource_name }}</strong> reserved on <strong>{{ r.controller_name }}</strong> from
                {{ r.start_datetime_formatted}} to {{ r.end_datetime_formatted }}
                {% else %}
                <strong>{{ r.controller_name }}</strong> reserved from
                {{ r.start_datetime_formatted }} to {{ r.end_datetime_formatted }}
                {% if r.link %}
                {% endif %}
                | <a href="{{ r.link }}" target="_blank">üîó Open Resource</a>
                {% endif %}
                | <a href="/delete_reservation/{{ r.id }}"
                    onclick="return confirm('Are you sure you want to cancel this reservation?');"
                    style="color: rgb(226, 85, 14); font-weight: bold;">Cancel</a>
            </li>
            {% endfor %}

        </ul>
        {% endif %}
    </div>


    <script>
        const startInput = document.getElementById('start_datetime');
        const endInput = document.getElementById('end_datetime');
        const reserveBtn = document.getElementById('reserveBtn');

        const maxDays = {{ max_days }};  // Injected from Flask

        const now = new Date();
        const formattedNow = now.toISOString().slice(0, 16);
        startInput.min = formattedNow;

        function updateEndDateLimit() {
            const startDate = new Date(startInput.value);
            if (!startInput.value) return;

            const maxEndDate = new Date(startDate.getTime() + maxDays * 24 * 60 * 60 * 1000);
            endInput.min = startInput.value;
            endInput.max = maxEndDate.toISOString().slice(0, 16);
        }

        function validateDates() {
            const startDate = new Date(startInput.value);
            const endDate = new Date(endInput.value);

            const isStartValid = startInput.value && startDate >= now;
            const isEndValid = endInput.value && endDate > startDate;
            const withinMaxDays = (endDate - startDate) <= maxDays * 24 * 60 * 60 * 1000;

            reserveBtn.disabled = !(isStartValid && isEndValid && withinMaxDays);
        }

        startInput.addEventListener('input', () => {
            updateEndDateLimit();
            validateDates();
        });

        endInput.addEventListener('input', validateDates);

        document.addEventListener("DOMContentLoaded", function() {
            const table = document.getElementById("inventoryTable");
            if (table)
                table.innerHTML = "";

            let tableHTML = `
                    <thead>
                        <tr>
                            <th>Manufacturer</th>
                            <th>AP</th>
                            <th>Controller</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    `;
            table.innerHTML = tableHTML;

            fetch(`/get_ap_status?ap_id=${ap_id}`)
                .then(response => response.json())
                .then(data => {
                    const status = data;
                    tableHTML += `
                            <tr>
                                <td>${manufacturer}</td>
                                <td>${ap}</td>
                                <td>
                                    ${controller}
                                </td>
                                <td id="status">
                                    <span class="status-indicator ${status.toLowerCase().replace(/ /g, '-')}"></span>
                                    ${status}
                                </td>
                            </tr>
                            `;

                    tableHTML += `</tbody>`;
                    table.innerHTML = tableHTML;
                })
                .catch(error => console.error("Some error occurred:" + error))

            });
    </script>


</body>

</html>