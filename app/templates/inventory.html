<!DOCTYPE html>
<html>

<head>
    <title>Inventory</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='inventory.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='sidebar.css') }}">
</head>

<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <img src="{{ url_for('static', filename='RUCKUS-Networks-Logos-artwork_white-orange.png') }}" alt="Logo"
            class="logo">
        <nav>
            <a href="{{ url_for('inventory.inventory') }}" {% if request.path.startswith('/inventory') %}class="active"
                {% endif %}>Inventory</a>
            <a href="{{url_for('reservation.reserve')}}" {% if request.path.startswith('/reserve') %}class="active" {%
                endif %}>Reserve</a>
            {% if role == 'admin' %}
            <a href="{{ url_for('inventory.admin_page') }}" {% if request.path.startswith('/admin') %}class="active" {%
                endif %}>Admin Page</a>
            <a href="{{ url_for('details.details') }}" {% if request.path.startswith('/details') %}class="active" {%
                endif %}>Details</a>
            {% endif %}
        </nav>
        <div class="sidebar-logout-separator"></div>
        <a href="{{ url_for('auth.login') }}" class="logout-btn">Logout</a>
    </div>

    <div class="container">
        <h1>Resource Inventory</h1>

        <!-- Search Box -->
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search resource..." onkeyup="filterTable()"
                style="padding: 10px; width: 100%; border-radius: 5px;">
        </div>

        <div class="drop-down-container">
            <!-- Manufacturer dropdown -->
            <div class="select-container">
                <label for="manufacturer">Manufacturer</label>
                <select id="manufacturer" onchange="getResourcesByManufacturer()" class="drop-down">
                    <option value="">Select manufacturer</option>
                    {% for m in manufacturers%}
                    <option value="{{m.name}}">{{m.name}}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="select-container">
                <label for="AP">AP</label>
                <select id="AP" onchange="getControllerByAP()" class="drop-down">
                    <option value="">Select AP</option>
                </select>
            </div>

            <div class="select-container">
                <label for="controller">Cloud / on-prem Controller</label>
                <select id="controller" onchange="showStatus()" class="drop-down">
                    <option value="">Select Cloud/on-prem Controllers</option>
                </select>
            </div>

            <div class="select-container">
                <label for="start-date">Start date</label>
                <input type="datetime-local" name="start-date" id="start-date">
            </div>

            <div class="select-container">
                <label for="end-date">End date</label>
                <input type="datetime-local" name="end-date" id="end-date">
            </div>
        </div>

        <!-- Inventory Table-->
        <table id="inventoryTable">
            <!-- <thead>
                <tr>
                    <th></th>
                    <th>Resource Name</th>
                    <th>AP Count</th>
                    <th>Status</th>
                    {% if role == 'admin' %}
                    <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for resource in resources %}
                <tr data-id="{{ resource.id }}">
                    <td><label class="custom-radio">
                            <input type="radio" name="resource" onchange="fetchControllers({{resource.id}})">
                            <span class="radio-icon"></span>
                        </label>
                    </td>
                    <td>{{ resource.name }}</td>
                    <td>{{ resource.ap_count }}</td>
                    <td>
                        <span class="status-indicator {{ resource.status | lower | replace(' ', '-') }}"></span>
                        {{ resource.status }}
                    </td>
                    {% if role == 'admin' %}
                    <td>

                        <a href="{{ resource.link }}" target="_blank"><button>Open</button></a>
                        <a href="/delete_resource/{{ resource.id }}"><button>Delete</button></a>
                        <button
                            onclick='openEditModal({{ resource.id }}, {{ resource.name | tojson }}, {{ resource.ap_count }}, {{ resource.status | tojson }})'>Edit
                        </button>

                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody> -->
        </table>

        <button id="reserveBtn" onclick="reserveSelection()">Reserve</button>

        {% if role == 'admin' %}
        <!-- Collapsible Add Resource Form -->
        <div class="add-resource-box">
            <button id="toggleAddFormBtn" class="collapsible-btn">
                <span style="vertical-align:middle;">+ Add Resource</span>
                <span id="arrow" class="arrow">&#9660;</span>
            </button>
            <div id="addResourceForm" style="display:none;">
                <form method="POST" action="/inventory" class="add-resource-form">
                    <input type="hidden" name="action_type" id="action_type" value="add">
                    <div class="form-row">
                        <select name="manufacturer" required>
                            <option value="" disabled selected>Select Manufacturer</option>
                            {% for m in manufacturers %}
                            <option value="{{m.id}}">{{m.name}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-row">
                        <input type="text" name="resource_name" placeholder="Resource Name" required>
                        <input type="number" name="ap_count" placeholder="AP Count" required>
                    </div>
                    <div class="form-row">
                        <select name="status" required>
                            <option value="" disabled selected>Select Status</option>
                            <option value="Available">Available</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Not Available">Not Available</option>
                        </select>
                        <input type="url" name="link" placeholder="Resource Link">
                    </div>


                    <div class="form-row">
                        <label for="controllers">Select Controllers</label>
                        <div id="controllers-container">
                            <!-- Checkboxes will be populated dynamically -->
                        </div>
                    </div>


                    <input type="hidden" name="resource_id" id="resource_id">
                    <button type="submit" class="submit-btn">Add Resource</button>
                </form>
            </div>
        </div>
        {% endif %}


        <!-- Edit Modal -->
        <div id="editModal"
            style="display:none; position:fixed; top:20%; left:35%; background:#333; color:white; padding:20px; border-radius:8px; box-shadow: 0 0 10px black; z-index: 200;">
            <h3>Edit Resource</h3>
            <form id="editForm" method="POST" action="/edit_resource">
                <input type="hidden" id="edit_id" name="id">
                <input type="text" id="edit_name" name="name" placeholder="Resource Name" required>
                <input type="number" id="edit_ap" name="ap_count" placeholder="AP Count" required>
                <input type="text" id="edit_status" name="status" placeholder="Status" required>
                <button type="submit">Save Changes</button>
                <button type="button"
                    onclick="document.getElementById('editModal').style.display='none'">Cancel</button>
            </form>
        </div>

        <!-- Reserve Modal -->
        <div id="reserveModal"
            style="display:none; position:fixed; top:15%; left:35%; background:#333; color:white; padding:20px; border-radius:8px; box-shadow: 0 0 10px black; z-index: 200;">
            <h3>Reserve Resource</h3>
            <form method="POST" action="/reserve_page">

                <!-- Manufacturer -->
                <div class="reserveForm-container">
                    <label>Manufacturer:</label>
                    <input type="text" id="manufacturer_name" value="" disabled>
                    <input type="hidden" id="manufacturer_id" name="manufacturer_id" value="">
                </div>

                <!-- AP -->
                <div class="reserveForm-container">
                    <label>Access Point:</label>
                    <input type="text" id="ap_name" value="" disabled>
                    <input type="hidden" id="ap_id" name="ap_id" value="">
                </div>

                <!-- Controller -->
                <div class="reserveForm-container">
                    <label>Controller:</label>
                    <input type="text" id="controller_name" value="" disabled>
                    <input type="hidden" id="controller_id" name="controller_id" value="">
                </div>

                <!-- Dates -->
                <div class="reserveForm-container">
                    <label>Start Date:</label>
                    <input type="datetime-local" id="start_datetime" name="start_datetime" readonly>
                </div>

                <div class="reserveForm-container">
                    <label>End Date:</label>
                    <input type="datetime-local" id="end_datetime" name="end_datetime" readonly>
                </div>

                <button type="submit">Confirm Reservation</button>
                <button type="button"
                    onclick="document.getElementById('reserveModal').style.display='none'">Cancel</button>
            </form>
        </div>

        {% if role == 'admin' %}
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const btn = document.getElementById('toggleAddFormBtn');
                const form = document.getElementById('addResourceForm');
                const arrow = document.getElementById('arrow');
                btn.onclick = function () {
                    if (form.style.display === 'none' || form.style.display === '') {
                        form.style.display = 'block';
                        arrow.style.transform = 'rotate(180deg)';
                    } else {
                        form.style.display = 'none';
                        arrow.style.transform = 'rotate(0deg)';
                    }
                };
            })


            function addResource() {
                const name = document.getElementById("resourceName").value;
                const ap = document.getElementById("apCount").value;
                const status = document.getElementById("status").value;

                if (name && ap && status) {
                    const table = document.getElementById("inventoryTable").getElementsByTagName('tbody')[0];
                    const row = table.insertRow();
                    row.innerHTML = `
                    <td>${name}</td>
                    <td>${ap}</td>
                    <td>${status}</td>
                    <td class="admin-only">
                        <button onclick="editRow(this)">Edit</button>
                        <button onclick="deleteRow(this)">Delete</button>
                    </td>
                `;
                    document.getElementById("resourceName").value = '';
                    document.getElementById("apCount").value = '';
                    document.getElementById("status").value = '';
                } else {
                    alert("Please fill all fields");
                }
            }

            function deleteRow(btn) {
                const row = btn.parentElement.parentElement;
                row.remove();
            }

            function editRow(btn) {
                const row = btn.parentElement.parentElement;
                const cols = row.getElementsByTagName("td");

                const name = cols[0].innerText;
                const ap = cols[1].innerText;
                const status = cols[2].innerText;

                // Set form values
                document.querySelector("input[name='resource_name']").value = name;
                document.querySelector("input[name='ap_count']").value = ap;
                document.querySelector("input[name='status']").value = status;

                // Set action type to edit
                document.getElementById("action_type").value = "edit";

                // Store resource ID (you'll need to add a data-id in your <tr> or <button>)
                document.getElementById("resource_id").value = row.getAttribute("data-id");
            }

            function openEditModal(id, name, ap, status) {
                document.getElementById('edit_id').value = id;
                document.getElementById('edit_name').value = name;
                document.getElementById('edit_ap').value = ap;
                document.getElementById('edit_status').value = status;
                document.getElementById('editModal').style.display = 'block';
            }

            function deleteController(id) {
                if (confirm("Are you sure you want to delete this controller?")) {
                    window.location.href = `/delete_controller/${id}`;
                }
            }

            function openEditControllerModal(id, name, status) {
                const modalContent = `
                <h3>Edit Controller</h3>
                <form id="editControllerForm" method="POST" action="/edit_controller">
                    <input type="hidden" name="id" value="${id}">
                    <input type="text" name="name" placeholder="Controller Name" value="${name}" required>
                    <button type="submit">Save Changes</button>
                    <button type="button" onclick="document.getElementById('editControllerModal').style.display='none'">Cancel</button>
                </form>
            `;
                let modal = document.getElementById('editControllerModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'editControllerModal';
                    modal.style.cssText = 'display:none; position:fixed; top:20%; left:35%; background:#333; color:white; padding:20px; border-radius:8px; box-shadow: 0 0 10px black; z-index: 200;';
                    document.body.appendChild(modal);
                }
                modal.innerHTML = modalContent;
                modal.style.display = 'block';
            }

            document.querySelector('select[name="manufacturer"]').addEventListener('change', function () {
                const manufacturerId = this.value;
                const controllerContainer = document.getElementById('controllers-container');

                // Clear previous checkboxes
                controllerContainer.innerHTML = '';

                // Fetch controllers for selected manufacturer
                fetch(`/get_controllers/${manufacturerId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        data.controllers.forEach(controller => {
                            const label = document.createElement('label');
                            label.style.display = 'block';

                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.name = 'controllers_list';
                            checkbox.value = controller.controller_id;

                            label.appendChild(checkbox);
                            label.appendChild(document.createTextNode(` ${controller.name}`));
                            controllerContainer.appendChild(label);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching controllers:', error);
                    });
            });

        </script>
        {% endif %}

        <script>

            function filterTable() {
                const input = document.getElementById("searchInput");
                const filter = input.value.toLowerCase();
                const rows = document.querySelectorAll("#inventoryTable tbody tr");

                rows.forEach(row => {
                    const resourceName = row.cells[0].innerText.toLowerCase();  // first column
                    if (resourceName.includes(filter)) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                });
            }

            function getResourcesByManufacturer() {
                clearTable();
                const select = document.getElementById("manufacturer");
                const manufacturer = select.value;

                // const table = document.getElementById("inventoryTable");
                // const controllersDiv = document.querySelector(".controller-cards");
                // controllersDiv.innerHTML = ""
                // if (table)
                //     table.innerHTML = "";
                // if (manufacturer === "") {
                //     document.getElementById("noResourcesMsg").style.display = "block";
                //     return;
                // }
                // document.getElementById("noResourcesMsg").style.display = "none";


                fetch(`/get_ap_by_manufacturer?manufacturer=${manufacturer}`)
                    .then(response => response.json())
                    .then(data => {
                        // console.log(data);

                        const apSelect = document.getElementById('AP');
                        apSelect.innerHTML = `<option value="">Select AP</option>`;

                        data.forEach(ap => {
                            let option = document.createElement('option');
                            option.innerHTML = ap.model_name;
                            option.value = ap.ap_id;
                            apSelect.appendChild(option);
                        })


                    })
                    .catch(error => console.error('Error fetching resources:', error));

                fetch(`/get_controllers_by_manufacturer?manufacturer=${manufacturer}`)
                    .then(response => response.json())
                    .then(data => {
                        // console.log(data);

                        const controllerSelect = document.getElementById('controller');
                        controllerSelect.innerHTML = `<option value="">Select Cloud/on-prem Controllers</option>`;

                        data.forEach(controller => {
                            let option = document.createElement('option');
                            option.textContent = controller.name;
                            option.value = controller.controller_id;
                            // console.log(option)
                            controllerSelect.appendChild(option);
                        })

                        // console.log(controllerSelect)


                    })
                    .catch(error => console.error('Error fetching resources:', error));
            }

            function getControllerByAP() {
                clearTable()
                const ap_id = document.getElementById('AP').value;
                // console.log(ap_id)
                if (ap_id == "") {
                    const select = document.getElementById("manufacturer");
                    const manufacturer = select.value;
                    fetch(`/get_controllers_by_manufacturer?manufacturer=${manufacturer}`)
                        .then(response => response.json())
                        .then(data => {
                            // console.log(data);

                            const controllerSelect = document.getElementById('controller');
                            controllerSelect.innerHTML = `<option value="">Select Cloud/on-prem Controllers</option>`;

                            data.forEach(controller => {
                                const option = document.createElement('option');
                                option.innerText = controller.name;
                                option.value = controller.controller_id;
                                console.log(option)
                                controllerSelect.appendChild(option);
                            })
                            console.log(controllerSelect)

                        })
                        .catch(error => console.error('Error fetching resources:', error));
                    return;
                }

                fetch(`/get_controllers_by_AP?ap_id=${ap_id}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(data)
                        const controllerSelect = document.getElementById('controller');
                        controllerSelect.innerHTML = `<option value="">Select Cloud/on-prem Controllers</option>`;

                        data.forEach(controller => {
                            let option = document.createElement('option');
                            option.innerHTML = controller.name;
                            option.value = controller.controller_id;
                            controllerSelect.appendChild(option);
                        })
                        // console.log(controllerSelect)
                    })
                    .catch(error => console.error('Error fetching resources:', error));
            }

            function showStatus() {
                const table = document.getElementById("inventoryTable");
                if (table)
                    table.innerHTML = "";

                const controllerSelect = document.getElementById('controller');
                const controller = controllerSelect.options[controllerSelect.selectedIndex].text;
                if (controller == "Select Cloud/on-prem Controllers") {
                    return;
                }

                const manufacturerSelect = document.getElementById('manufacturer');
                const manufacturer = manufacturerSelect.options[manufacturerSelect.selectedIndex].text;

                const apSelect = document.getElementById('AP');
                const ap = apSelect.options[apSelect.selectedIndex].text;
                const ap_id = apSelect.value;

                let tableHTML = `
                    <thead>
                        <tr>
                            <th>Manufacturer</th>
                            <th>AP</th>
                            <th>Controller</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    `;
                table.innerHTML = tableHTML;

                fetch(`/get_ap_status?ap_id=${ap_id}`)
                    .then(response => response.json())
                    .then(data => {
                        const status = data;
                        tableHTML += `
                            <tr>
                                <td>${manufacturer}</td>
                                <td>${ap}</td>
                                <td>
                                    ${controller}
                                </td>
                                <td id="status">
                                    <span class="status-indicator ${status.toLowerCase().replace(/ /g, '-')}"></span>
                                    ${status}
                                </td>
                            </tr>
                            `;

                        tableHTML += `</tbody>`;
                        table.innerHTML = tableHTML;
                    })
                    .catch(error => console.error("Some error occurred:" + error))

            }

            function clearTable() {
                const table = document.getElementById("inventoryTable");
                if (table)
                    table.innerHTML = "";
            }

            function fetchControllers(resourceId) {
                fetch(`/get_controllers_by_resource?resource_id=${resourceId}`)
                    .then(response => response.json())
                    .then(controllers => {
                        disableControllers();

                        controllers.forEach(controller => {
                            enableControllers(controller.name);

                        });
                    })
                    .catch(error => console.error('Error fetching controllers:', error));
            }

            function reserveSelection() {
                const controllerSelect = document.getElementById('controller');
                const manufacturerSelect = document.getElementById('manufacturer');
                const apSelect = document.getElementById('AP');
                const start_date = document.getElementById('start-date')
                const end_date = document.getElementById('end-date');

                const manufacturer = manufacturerSelect.options[manufacturerSelect.selectedIndex]
                const controller = controllerSelect.options[controllerSelect.selectedIndex].text;
                const ap = apSelect.options[apSelect.selectedIndex].text;
                const start = start_date.value;
                const end = end_date.value;

                const controller_id = controllerSelect.value;
                const manufacturer_id = manufacturerSelect.value;
                const ap_id = apSelect.value;

                if (controller_id === "" || manufacturer_id === "" || ap_id === "" || start === "" || end === "") {
                    alert("Select a manufacturer,AP and controller before reserving");
                    return;
                }

                const status = document.getElementById('status').innerText.trim();
                if (status != "Available") {
                    alert("Resource cannot be reserved");
                    return;
                }

                console.log(ap)
                document.getElementById('manufacturer_id').value = manufacturer_id;
                document.getElementById('manufacturer_name').value = manufacturer.text;

                document.getElementById('ap_id').value = ap_id;
                document.getElementById('ap_name').value = ap;

                document.getElementById('controller_id').value = controller_id;
                document.getElementById('controller_name').value = controller;

                document.getElementById('start_datetime').value = start;
                document.getElementById('end_datetime').value = end;

                document.getElementById('reserveModal').style.display = 'block';

                // Redirect to reservation page with query parameters
                // window.location.href = `/reserve_page?resource_id=${ap_id}&controller_id=${controller_id}&controller=${controller}&ap=${ap}`;
            }
        </script>
</body>

</html>